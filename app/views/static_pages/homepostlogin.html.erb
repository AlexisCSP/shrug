<!DOCTYPE html>
<html>
<p>

<head>
    <style>
      #map {
        height: 400px;
        width: 60%;
       }

    </style>
  </head>
  <body>

    <div id="map">
    <script>
    	 var map, infoWindow;

       var savePosition=function(position){
         $.ajax({
           type:'POST',
           url:'/update_latlng',
           data: {'latitude': position.lat,
                  'longitude': position.lng},
              success:function(){

            }
          });
        }

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 6
        });

        infoWindow = new google.maps.InfoWindow;

        //geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {

            // obtain locations of chatrooms longitude-latitude organized

            var locations = <%= raw @chat_rooms_information.to_json %>

            //for each location, put marker at lat and lng
            for (i = 0; i < locations.length; i++) {
              var p = new google.maps.LatLng(locations[i][1], locations[i][2]);
              marker = new google.maps.Marker({
              position: p, title: locations[i][0], map:map });
              //TODO change this fugly marker - I put it here for testing
              marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
            }

          // set geolocation pin
            var pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };

            map.setCenter(pos);

            var marker = new google.maps.Marker({position: pos,title:"You are here!" });

            //radius around user's location
            var circle = new google.maps.Circle({ radius: 1000, map:map, fillColor: '#38891b', fillOpacity: 0.4, strokeColor: '#5e5e5e', strokeWeight: 1});
            circle.bindTo('center', marker, 'position');

            //set user location marker, move view to user location, zoom in
      	    marker.setMap(map);
      	    map.setZoom(16);
  			    map.panTo(pos);

            savePosition(pos);

          },function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });

        } else { //cant get geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }


      function downloadUrl(url, callback) {
        var request = window.ActiveXObject ?
            new ActiveXObject('Microsoft.XMLHTTP') :
            new XMLHttpRequest;

        request.onreadystatechange = function() {
          if (request.readyState == 4) {
            request.onreadystatechange = doNothing;
            callback(request.responseText, request.status);
          }
        };
    }

    </script>
    </div>

<!--Drop pins for location-->



    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt4_0BPK9TgwPMo3mI-dz6v8Mg1MW-8n0&callback=initMap">
    </script>

<!--chatroom box -->
  <div class="tab">
  <button class="tablinks" onclick="opentab(event, 'NearbyChatRooms')" id= "startopen"><strong>Nearby Chat Rooms</strong></button>
  <button class="tablinks" onclick="opentab(event, 'NearbyPeople')"><strong>Nearby People</strong></button>

  <div id= "NearbyChatRooms" class="tabcontent">
	<%=render @chat_rooms%>
  </div>

  <div id= "NearbyPeople" class= "tabcontent">
  people

  </div>

</div>


<script>
document.getElementById("startopen").click();

 function opentab(event, type){
   var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(type).style.display = "block";
    event.currentTarget.className += " active";
}

</script>

<!-- The Modal -->
<button  id="Btn">Create a room!</button>

	<div id="Modal" class="modal">

		<div class="modal-content">
		    <span class="close">&times;</span> <br>


        <div class="row">
          <div class="col-md-6 col-md-offset-3">
            <%= form_for(@chat_room, url: new_chatroom_path) do |f| %>

              <%= f.label :title %>
            	<%= f.text_field :title, autofocus: true, class: 'form-control' %>

        		  <%= f.label :description %>
            	<%= f.text_area :description, rows: "5", autofocus: true, class: 'form-control' %>

              <%= f.hidden_field :latitude, value: current_user.latitude %>
              <%= f.hidden_field :longitude, value: current_user.longitude %>

              <%= f.hidden_field :user_id, value: current_user.id %>
              <%= f.submit "Create Chat Room", class: "btn btn-primary" %>
            <% end %>
          </div>
        </div>


		</div>

	</div>


<script>

// Get the modal
var modal = document.getElementById('Modal');

// Get the button that opens the modal
var btn = document.getElementById("Btn");

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal
btn.onclick = function() {
    modal.style.display = "block";
}

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>


</body>


</html>
